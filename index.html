<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>US Vaccination Map</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />

  <!-- Load MapLibre GL JS -->
  <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
  <link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet" />

  <!-- MapLibre Geocoder -->
  <script src="https://cdn.jsdelivr.net/npm/@maplibre/maplibre-gl-geocoder@1.7.0/dist/maplibre-gl-geocoder.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@maplibre/maplibre-gl-geocoder@1.7.0/dist/maplibre-gl-geocoder.css" />
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <style>
    body { margin: 0; padding: 0; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }
    #search-toggle {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 2;
      background: white;
      border-radius: 6px;
      padding: 5px 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
      font-family: sans-serif;
    }

    .maplibregl-ctrl-top-right { z-index: 10; }

    @media (max-width: 768px) {
      .maplibregl-ctrl-top-right {
        top: 70px !important;
        right: 10px !important;
      }

      .maplibregl-ctrl-geocoder {
        max-width: 80% !important;
        font-size: 14px !important;
      }

      #search-toggle {
        top: 10px;
        left: 10px;
        padding: 4px 8px;
        font-size: 14px;
      }
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <div id="search-toggle">
    <label><input type="radio" name="searchMode" value="county" checked> County</label>
    <label><input type="radio" name="searchMode" value="zip"> ZIP Code</label>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', async () => {
    // Detect mobile
    const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

    // Create map
    const map = new maplibregl.Map({
      container: 'map',
      style: {
        version: 8,
        sources: {
          'osm-tiles': {
            type: 'raster',
            tiles: [
              'https://a.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
              'https://b.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png'
            ],
            tileSize: 256,
            attribution: '© OpenStreetMap contributors © CARTO'
          }
        },
        layers: [
          {
            id: 'osm-tiles',
            type: 'raster',
            source: 'osm-tiles'
          }
        ]
      },
      center: isMobile ? [-96, 37.5] : [-98, 38.5],
      zoom: isMobile ? 3 : 4,
      minzoom: 2,
      maxzoom: 12
    });

    // Add zoom and rotation controls
    map.addControl(new maplibregl.NavigationControl(), 'top-right');

    const popup = new maplibregl.Popup({ closeButton: false, closeOnClick: false });

    let countyData;
    let zipData;

    map.on('load', async () => {
      const countyResponse = await fetch('counties.geojson');
      countyData = await countyResponse.json();
      countyData.features.forEach(f => {
        if (f.properties.mean_vaccination_rate_county == null)
          f.properties.mean_vaccination_rate_county = 0;
      });

      map.addSource('counties', { type: 'geojson', data: countyData });

      map.addLayer({
        id: 'county-fill',
        type: 'fill',
        source: 'counties',
        maxzoom: 7,
        paint: {
          'fill-color': [
            'interpolate', ['linear'], ['get', 'mean_vaccination_rate_county'],
            0, '#89cff1',
            40, '#6eb1d6',
            50, '#5293bb',
            60, '#3776a1',
            70, '#1b5886',
            80, '#1b2d86',
            90, '#06124d'
          ],
          'fill-opacity': 0.7
        }
      });

      map.addLayer({
        id: 'county-outline',
        type: 'line',
        source: 'counties',
        maxzoom: 9,
        paint: { 'line-color': '#555', 'line-width': 0.5 }
      });

      // ZIP layer handling
      if (!isMobile) {
        const zipResponse = await fetch('zipcodes.geojson');
        zipData = await zipResponse.json();
        map.addSource('zipcodes', { type: 'geojson', data: zipData });
      } else {
        console.log('(MOBILE) Skipping full ZIP load, initializing empty ZIP layer');
        zipData = { type: 'FeatureCollection', features: [] };
        map.addSource('zipcodes', { type: 'geojson', data: zipData });
      }

      map.addLayer({
        id: 'zip-fill',
        type: 'fill',
        source: 'zipcodes',
        minzoom: 7,
        paint: {
          'fill-color': [
            'match', ['get', 'risk_level_zcta'],
            'Lowest Risk (85%+)', '#89cff1',
            'Low Risk (80–84%)', '#6eb1d6',
            'Medium Risk (70–79%)', '#5293bb',
            'High Risk (60–69%)', '#1b2d86',
            'Very High Risk (<60%)', '#06124d',
            '#cccccc'
          ],
          'fill-opacity': 0.7
        }
      });

      map.addLayer({
        id: 'zip-outline',
        type: 'line',
        source: 'zipcodes',
        minzoom: 7,
        paint: { 'line-color': '#444', 'line-width': 0.3 }
      });

      // Hover tooltip for counties
      map.on('mousemove', 'county-fill', e => {
        const f = e.features[0];
        popup.setLngLat(e.lngLat)
          .setHTML(`<h1>${f.properties.county_state}</h1><br>
            <b>Mean Vaccination Rate:</b> ${f.properties.mean_vaccination_rate_county}%<br>
            <b>Risk Level:</b> ${f.properties.risk_level_county}<br>
            <b>Statewide Measles Cases in 2025:</b> ${f.properties.cases}`)
          .addTo(map);
      });
      map.on('mouseleave', 'county-fill', () => popup.remove());

      // Hover tooltip for ZIPs
      map.on('mousemove', 'zip-fill', e => {
        const f = e.features[0];
        popup.setLngLat(e.lngLat)
          .setHTML(`<h1>ZIP ${f.properties.zcta5}</h1><br>
            <b>Zip Code Risk Level:</b> ${f.properties.risk_level_zcta}<br>
            <b>County Risk Level:</b> ${f.properties.risk_level_county}<br>
            <b>State Measles Cases in 2025:</b> ${f.properties.cases}`)
          .addTo(map);
      });
      map.on('mouseleave', 'zip-fill', () => popup.remove());

      // Geocoder setup
      const geocoder = new MaplibreGeocoder({
        placeholder: 'Search by county or ZIP code...',
        flyTo: false,
        zoom: null,
        collapsed: false,
        forwardGeocode: async (query) => {
          try {
            const results = [];
            const mode = document.querySelector('input[name="searchMode"]:checked').value;
            const q = (
              typeof query === 'string'
                ? query
                : query && query.query
                  ? query.query
                  : ''
            ).trim().toLowerCase();

            if (!q) return { features: [] };

            if (mode === 'county') {
              const res = await fetch('counties.geojson');
              const data = await res.json();
              data.features.forEach(f => {
                const name = (f.properties.county_state || '').toLowerCase();
                if (name.includes(q)) {
                  let center = [-98, 38.5];
                  if (f.geometry && f.geometry.coordinates && f.geometry.coordinates.length) {
                    try { center = turf.center(f).geometry.coordinates; } 
                    catch (err) { console.warn('turf.center failed', err); }
                  }
                  results.push({
                    type: 'Feature',
                    geometry: { type: 'Point', coordinates: center },
                    place_name: `${f.properties.county_state}`,
                    text: `${f.properties.county_state}`,
                    center,
                    properties: f.properties
                  });
                }
              });
            } else if (mode === 'zip') {
              const res = await fetch('zipcodes.geojson');
              const data = await res.json();
              data.features.forEach(f => {
                const zip = String(f.properties.zcta5 || '');
                if (zip.startsWith(q)) {
                  let center = [-98, 38.5];
                  if (f.geometry && f.geometry.coordinates && f.geometry.coordinates.length) {
                    try { center = turf.center(f).geometry.coordinates; }
                    catch (err) { console.warn('turf.center failed for ZIP', zip, err); }
                  }
                  results.push({
                    type: 'Feature',
                    geometry: { type: 'Point', coordinates: center },
                    place_name: `ZIP ${f.properties.zcta5}`,
                    text: `ZIP ${f.properties.zcta5}`,
                    center,
                    properties: f.properties
                  });
                }
              });
            }

            return { features: results };
          } catch (err) {
            console.error("Error in forwardGeocode:", err);
            return { features: [] };
          }
        }
      }, { maplibregl: maplibregl });

      map.addControl(geocoder, 'top-right');
    });
  });
  </script>
</body>
</html>
